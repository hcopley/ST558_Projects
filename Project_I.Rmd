---
title: "Project 1"
author: "Heather Copley & Andy Johnson"
date: "2023-08-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)

```

## Data Input - transforamtion without creating a function

```{r}
sheet1 <- read_csv("https://www4.stat.ncsu.edu/~online/datasets/EDU01a.csv") %>%
    select(area_name = Area_name, STCOU, ends_with('D')) %>%
    pivot_longer(cols = ends_with('D'), names_to = 'Enrollment_code', values_to = 'Enrollment_value') %>%
    mutate(year = year(as.Date(substr(Enrollment_code, 8,9), format = '%y')),
           measurement = substr(Enrollment_code, 1, 7))


county_data <- sheet1 %>%
    filter(str_detect(area_name, ',' ))

class(county_data) <- c('county', class(county_data))

county_data <- county_data %>%
    mutate(state = substr(area_name, nchar(area_name) -1, nchar(area_name)))


non_county_data <- sheet1 %>%
    filter(!str_detect(area_name, ',' )) %>%
    mutate(division = case_when(area_name %in% toupper(c('Connecticut', 'Maine', 'Massachusetts', 'New Hampshire', 'Rhode Island', 'Vermont')) ~ 'Division 1',
                                area_name %in% toupper(c('New Jersey', 'New York','Pennsylvania')) ~ 'Division 2',
                                area_name %in% toupper(c('Illinois', 'Indiana', 'Michigan', 'Ohio','Wisconsin')) ~ 'Division 3',
                                area_name %in% toupper(c('Iowa', 'Kansas', 'Minnesota', 'Missouri', 'Nebraska', 'North Dakota', 'South Dakota')) ~ 'Division 4',
                                area_name %in% toupper(c('Delaware', 'Florida', 'Georgia', 'Maryland', 'North Carolina', 'South Carolina', 'Virginia', 'District of Columbia', 'West Virginia')) ~ 'Division 5',
                                area_name %in% toupper(c('Alabama', 'Kentucky', 'Mississippi', 'Tennessee')) ~ 'Division 6',
                                area_name %in% toupper(c('Arkansas', 'Louisiana', 'Oklahoma', 'Texas')) ~ 'Division 7',
                                area_name %in% toupper(c('Arizona', 'Colorado', 'Idaho', 'Montana', 'Nevada', 'New Mexico', 'Utah', 'Wyoming')) ~ 'Division 8',
                                area_name %in% toupper(c('Alaska', 'California', 'Hawaii', 'Oregon', 'Washington')) ~ 'Division 9',
                                TRUE ~ 'ERROR' )
                                )

class(non_county_data) <- c('state', class(county_data))

```


## Select columns and pivot from wide to long 

```{r}


select_and_pivot <- function(.data, var_name = 'Enrollment') {
    
    
    out <- .data %>%
            select(area_name = Area_name, STCOU, ends_with('D')) %>%
            pivot_longer(cols = ends_with('D'), names_to = 'Code', values_to = var_name)
    
    out
    
} 



```

## Extract Year and Measurement

```{r}

extract_year_measurement <- function(.data, ...) {
    
    
    out <- .data %>%
         mutate(year = year(as.Date(substr(Code, 8,9), format = '%y')),
           measurement = substr(Code, 1, 7))
        
    out
    
}


```

## Split the data into county and state

```{r}

split_areas <- function(.data, ...) {
    
    out <- .data %>%
        mutate(name = if_else(str_detect(area_name, ','), 'County', 'Non_County')) %>%
        split(.$name)
        
   class(out$County) <- c('county', class(out$County))
   class(out$Non_County) <- c('state', class(out$Non_County))
   
   
   out
}

```

## Extract the state (for the county data)

```{r}
extract_state <- function(.data, ...) {
    
    out <- .data
    
    if('county' %in% class(.data)) {
    
    out <- out %>%
    mutate(state = substr(area_name, nchar(area_name) -1, nchar(area_name)))
    
    }
    
    out

}


```


## Assign Divisions to the states (for the non-county data)

```{r}

assign_division <- function(.data, ...) {
    
    out <- .data
    
    if('state' %in% class(.data)) {
     
        out <- out %>%
        filter(!str_detect(area_name, ',' )) %>%
        mutate(division = case_when(area_name %in% toupper(c('Connecticut', 'Maine', 'Massachusetts', 'New Hampshire', 'Rhode Island', 'Vermont')) ~ 'Division 1',
                                area_name %in% toupper(c('New Jersey', 'New York','Pennsylvania')) ~ 'Division 2',
                                area_name %in% toupper(c('Illinois', 'Indiana', 'Michigan', 'Ohio','Wisconsin')) ~ 'Division 3',
                                area_name %in% toupper(c('Iowa', 'Kansas', 'Minnesota', 'Missouri', 'Nebraska', 'North Dakota', 'South Dakota')) ~ 'Division 4',
                                area_name %in% toupper(c('Delaware', 'Florida', 'Georgia', 'Maryland', 'North Carolina', 'South Carolina', 'Virginia', 'District of Columbia', 'West Virginia')) ~ 'Division 5',
                                area_name %in% toupper(c('Alabama', 'Kentucky', 'Mississippi', 'Tennessee')) ~ 'Division 6',
                                area_name %in% toupper(c('Arkansas', 'Louisiana', 'Oklahoma', 'Texas')) ~ 'Division 7',
                                area_name %in% toupper(c('Arizona', 'Colorado', 'Idaho', 'Montana', 'Nevada', 'New Mexico', 'Utah', 'Wyoming')) ~ 'Division 8',
                                area_name %in% toupper(c('Alaska', 'California', 'Hawaii', 'Oregon', 'Washington')) ~ 'Division 9',
                                TRUE ~ 'ERROR' )
                                )
    }
    
     out
     
}



```

## Combine splitting, extracting state, and assigning divisions

```{r}

split_extract_assign <- function(.data, ...) {
    
    splits <- split_areas(.data)
    
   out <- splits %>%
       map(select, -name) %>%
       map(extract_state) %>%
       map(assign_division)
    
    out
    
}

```


## Wrapper function 

```{r}

wrapper_function <- function(url,...) {
    
    #read in the data
    out_1 <- read.csv(url)
    #select columns and pivot from wide to long
    out_2 <- select_and_pivot(out_1,...)
    #extract year and measurement
    out_3 <- extract_year_measurement(out_2, ...)
    #split data into county and state, extract state, and assign divisions
    final_out <- split_extract_assign(out_3, ...) 
    
    final_out

    
    }
```


## Call function and combine output


```{r } 

EDU01a <- wrapper_function("https://www4.stat.ncsu.edu/~online/datasets/EDU01a.csv")
    
EDU01b <- wrapper_function("https://www4.stat.ncsu.edu/~online/datasets/EDU01b.csv")

combine_data <- function(datasets) {
    
    County <- datasets %>%
        map(pluck, 'County') %>%
        bind_rows()
        
        
    State <- datasets %>%
        map(pluck, 'Non_County') %>%
        bind_rows()
    
    list('County' = County, 'State' = State)
    
    
}


dat <- list(EDU01a, EDU01b) %>%
   combine_data()

```


## Generic Plot function for summarizing state data

```{r}

plot.state <- function(.data, var_name = 'Enrollment') {
    
    out_data <- .data %>%
        filter(division != 'ERROR') %>%
        group_by(year, division) %>%
        summarise(mean = mean(get(var_name)))
        
        
    out_plot <- ggplot(out_data, aes(x = year, y = mean, color = division)) + 
        geom_line()
    
    out_plot
    
        
}

plot(dat$State, var_name = 'Enrollment')

```

## Generic Plot function for summarizing county data

```{r}

plot.county <- function(.data, state_name = 'NC', var_name = 'Enrollment', order = 'top', num = 5) {
    
    
    state_data <- .data %>%
        filter(state == state_name) 
    
    means <- state_data %>%
        group_by(area_name) %>%
        summarise(mean = mean(get(var_name))) 
    
    
    if(order == 'top') {
        
        plot_order <-  means %>%
            arrange(-mean) %>%
            head(num)
    }
    
    if(order == 'bottom') {
        
        plot_order <- means %>%
            arrange(mean) %>%
            head(num)
        
    }
    
    plot_data <- state_data %>%
        filter(area_name %in% plot_order$area_name) 
    
    out_plot <- ggplot(plot_data, aes(x = year, y = get(var_name), color = area_name)) + 
        geom_line() +
        ylab(var_name)
    
    out_plot
    
}

plot(dat$County, order = 'bottom', num = 7)



```



## Put it all together

```{r}
#read in and prep data
EDU01a <- wrapper_function("https://www4.stat.ncsu.edu/~online/datasets/EDU01a.csv")
    
EDU01b <- wrapper_function("https://www4.stat.ncsu.edu/~online/datasets/EDU01b.csv")

#combine datasets into state and county
dat <- list(EDU01a, EDU01b) %>%
   combine_data()

plot(dat$State, var_name = 'Enrollment')
plot(dat$County, state_name = 'NC', order = 'top', num = 10)
plot(dat$County, state_name = 'AZ', order = 'bottom', num = 6)
plot(dat$County)
plot(dat$County, state_name = 'OH', order = 'top', num = 8)



```

## Read in more data

```{r}

PST01a <- wrapper_function("https://www4.stat.ncsu.edu/~online/datasets/PST01a.csv")
PST01b <- wrapper_function("https://www4.stat.ncsu.edu/~online/datasets/PST01b.csv")
PST01c <- wrapper_function("https://www4.stat.ncsu.edu/~online/datasets/PST01c.csv")
PST01d <- wrapper_function("https://www4.stat.ncsu.edu/~online/datasets/PST01d.csv")

dat <- list(PST01a, PST01b, PST01c, PST01d) %>%
    combine_data()

plot(dat$State)

plot(dat$County, state_name = 'PA', order = 'top', num = 5)
plot(dat$County, state_name = 'TX', order = 'bottom', num = 12)
plot(dat$County)
plot(dat$County, state_name = 'NY', order = 'top', num = 6)


```


## todo: Add comments/comentary throughout

## todo: make html output look nice
